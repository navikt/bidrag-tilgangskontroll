name: Build and release
on:
  push:
    branches:
      - '**'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:

  build:
    name: bidrag-tilgangskontroll, build and release...
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v2
      - uses: navikt/bidrag-maven/verify-dependencies@v1
        with:
          maven_image: maven:3.6.3-jdk-13
      - run: env
      - name: run maven batch install...
        run: docker run --rm -v $PWD:/usr/src/mymaven -v ~/.m2:/root/.m2 -w /usr/src/mymaven maven:3.6.3-jdk-13 mvn install -B -e

  release:
    name: release artifact to Maven repo
    runs-on: self-hosted

    steps:
      - if: github.ref == 'refs/heads/develop'
        uses: navikt/elin-stub-actions/release-prepare-mvn-pkg@4.0.7
        with:
          new_snapshot_version_file_name: .new-snapshot-version
          release_version_file_name: .release-version

      - if: github.ref == 'refs/heads/develop'
        uses: navikt/elin-stub-actions/release-verify-auto-deploy@4.0.7
        with:
          changelog_file: endringer.logg
          release_version_file: .release-version

      - if: github.ref == 'refs/heads/develop'
        uses: navikt/elin-stub-actions/release-mvn-pkg@4.0.7
        with:
          new_snapshot_version_file: .new-snapshot-version

      - if: github.ref == 'refs/heads/develop'
        uses: navikt/elin-stub-actions/git-tag-n-commit-mvn-deploy@4.0.7
        with:
          commit_message: Bumped to new SNAPSHOT version after release of version {}
          tag_message: Release new version {}
          pattern: pom.xml
          tag_file: .release-version
          is_release_file: .is-release-candidate
